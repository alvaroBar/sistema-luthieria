<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova Ordem de Serviço</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- CABEÇALHO DA PÁGINA -->
        <div class="page-header">
            <div class="header-title">
                <h1>Nova Ordem de Serviço</h1>
                <p class="subtitle">Abra uma nova OS para o equipamento selecionado.</p>
            </div>
        </div>

        <!-- CARD COM O FORMULÁRIO -->
        <div class="card">
            <div class="info-box" style="background-color: var(--cor-fundo); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>Cliente:</strong> {{ cliente.nome }} <br>
                <strong>Equipamento:</strong> {{ equipamento.tipo }} {{ equipamento.marca }} - {{ equipamento.modelo }}
            </div>

            <form method="POST">
                <div class="form-grid">
                    <label for="descricao_problema" class="full-width">Descrição do Problema (Relatado pelo Cliente):</label>
                    <textarea id="descricao_problema" name="descricao_problema" required class="full-width" style="min-height: 100px;"></textarea>

                    <label class="full-width">Acessórios na Entrada:</label>
                    <div class="radio-group full-width">
                        <input type="radio" id="sem_capa" name="acessorios_entrada" value="Sem Capa" checked>
                        <label for="sem_capa">Sem Capa</label>

                        <input type="radio" id="com_capa" name="acessorios_entrada" value="Com Capa (Bag)">
                        <label for="com_capa">Com Capa (Bag)</label>

                        <input type="radio" id="com_case" name="acessorios_entrada" value="Com Case">
                        <label for="com_case">Com Case</label>
                    </div>

                    <label for="acessorios_obs" class="full-width">Outros Acessórios / Observações:</label>
                    <input type="text" id="acessorios_obs" name="acessorios_obs" class="full-width" placeholder="alavanca, correia, etc." value="Cliente deixou ">

                    <!-- SEÇÃO DE PREVISÃO DE ENTREGA ATUALIZADA -->
                    <label for="prazo_dias">Prazo (em dias):</label>
                    <input type="number" id="prazo_dias" placeholder="Ex: 7" min="0">

                    <label for="data_previsao_saida">Ou Data Específica:</label>
                    <input type="date" id="data_previsao_saida" name="data_previsao_saida">
                </div>

                <hr>

                <div class="actions-cell" style="justify-content: flex-end;">
                    <a href="{{ url_for('main.listar_equipamentos', cliente_id=cliente.id) }}" class="action-link">Cancelar</a>
                    <button type="submit">Abrir Ordem de Serviço</button>
                </div>
            </form>
        </div>
    </div>
    <style>
        .radio-group { display: flex; align-items: center; gap: 20px; }
        .radio-group input { width: auto; }
        .info-box { border: 1px solid var(--cor-borda); }
    </style>

    <!-- SCRIPT PARA CÁLCULO DE DATA -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const prazoDiasInput = document.getElementById('prazo_dias');
            const dataPrevisaoInput = document.getElementById('data_previsao_saida');

            // Função para calcular e definir a data de previsão com base nos dias
            function calcularDataPrevisao() {
                const dias = parseInt(prazoDiasInput.value, 10);
                if (!isNaN(dias) && dias >= 0) {
                    const hoje = new Date();
                    hoje.setDate(hoje.getDate() + dias);

                    // Formata a data para YYYY-MM-DD
                    const ano = hoje.getFullYear();
                    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
                    const dia = String(hoje.getDate()).padStart(2, '0');

                    dataPrevisaoInput.value = `${ano}-${mes}-${dia}`;
                } else {
                    dataPrevisaoInput.value = '';
                }
            }

            // Função para calcular os dias com base na data selecionada
            function calcularDias() {
                if (dataPrevisaoInput.value) {
                    const hoje = new Date();
                    hoje.setHours(0, 0, 0, 0); // Zera as horas para comparar apenas as datas

                    const dataPrevisao = new Date(dataPrevisaoInput.value + 'T00:00:00'); // Garante que a hora seja meia-noite

                    if (dataPrevisao >= hoje) {
                        const diferencaEmMs = dataPrevisao.getTime() - hoje.getTime();
                        const diferencaEmDias = Math.ceil(diferencaEmMs / (1000 * 60 * 60 * 24));
                        prazoDiasInput.value = diferencaEmDias;
                    } else {
                        prazoDiasInput.value = '';
                    }
                } else {
                     prazoDiasInput.value = '';
                }
            }

            // Adiciona os "ouvintes" de eventos para sincronizar os campos
            prazoDiasInput.addEventListener('input', calcularDataPrevisao);
            dataPrevisaoInput.addEventListener('input', calcularDias);
        });
    </script>
</body>
</html>

